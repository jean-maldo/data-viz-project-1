<!DOCTYPE html>
<html>

    <head>
        <title>Flight Delays and Cancellations in 2016</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <style>
            map_svg {border: 1px solid black}
            .point { fill: black; }
            path.trajectory { fill: none; }
            path.state { fill: #eee; stroke: #aaa; }

            /*svg { border: solid #ccc 1px;}*/
            path.lineGraph { fill: none; stroke-width: 2; }

            svg {
                border: 1px solid darkgrey;
                position: relative;

            }

            h1, h2, h3, .brand-logo {
                font-family: 'Bungee', Helvetica, Arial;
                color: var(--font-color);
            }

            h2 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1em;
            }

            body {
                font-family: 'Nunito', Helvetica, Arial;
                font-weight: 300;
                font-size: 1.0em;
                line-height: 1.8em;
                min-width: 340px;

                color: var(--font-color);
            }

            strong {
                font-weight: 700;
            }

            div {
                background-color: #f7f7f7;
                width: 1000px;
                border: 5px plum;
                padding: 5px;
                margin: 10px;
            }

            .filled {
                fill: url(#mainGradient);
            }

            .outlined {
                fill: none;
                stroke: url(#mainGradient);
                stroke-width: 4;
            }
        </style>
    </head>

    <body>
        <h1>INFO 5100 (Project 1) - Flight Delays and Cancellations in 2016</h1>

        <div id="map">Flight Delay Causes - 20 Busiest Airports (NYC airports averaged)
            <br />
            <svg id="map_delays" height="620" width="900">
            </svg>
        </div>

        <h2>Average Delays by Airlines</h2>
        <div> The graph presents the annual average of delay time for 12 airlines in the U.S. in 2016. Each line represents the trend of the change of delay time in different days in a week. The linewidth means the total number of flights for each airline in 2016, and these 12 airlines are labeled with different colors.

            </div>
        <!-- <div id="lineGraph">Average Delays by Airlines
            <br /> -->
            <svg id="lineGraph_dalays" height="450" width="820">
              <path d=" M 560 50
                L 560 350"
                stroke="black"
                stroke-opacity=0.5
                stroke-dasharray="5,5"  />
            </svg>
        <!-- </div> -->
<h2>Cancellation and Delays by Airlines</h2>
<div> This graph shows the cancellation and delays of flights from the top 10 airlines (most flights) for 2016 in the USA. The airline carriers
    are ranked in decreasing order by the number of flights in 2016. The purple bars on the left show the number of cancellations.The bars
    on the right side show the number of delays in 2016, and the numbers in the middle of the bars represent the average length of the delay.
    The patterns of the delay bars correspond to the most frequent cause of delay.
    </div>

<svg id="airline_delays" height="800" width="1000"></svg>
        <script>
            // svg selectors
            var map_svg = d3.select("#map_delays");
            var svg_lineGraph = d3.select("#lineGraph_dalays");
            var svg_barchart = d3.select("#airline_delays");


            // color scales
            var colorScale_lineGraph = d3.scaleOrdinal(d3.schemeCategory20);
            var colorScale_map = d3.scaleOrdinal(d3.schemeCategory10);

            // Map Projection
            var projection = d3.geoAlbersUsa();
            var pathGenerator = d3.geoPath().projection(projection);

            // Variables to hold data for map graph
            var rawFlightData, flightData, busiest20Airports, mergedAirports = [], airportData = {}, rawDataAirport, states;

            // Variables to hold data for line graph
            var rawDataAirline, dailyFlightData, airlineDataByDay = [];

            // Variables to hold data for line graph
            var top10Airline, airlineDataByDelays=[], tempArray = {}, reasonsDelayBar = ["carrierDelays", "lateAircraftDelays", "nasDelays", "securityDelays", "weatherDelays"];
            var reasonsCancellationBar = ["carrierCancellations", "weatherCancellations", "nasCancellations", "securityCancellations"];
            
            var cancellationsAirlineExtent, delaysAirlineExtent;
                
            var width_barchart = svg_barchart.attr("width");
            var height_barchart = svg_barchart.attr("height");
            
            function parseAirportsLine (line) {
                line.LATITUDE = Number(line.LATITUDE);
                line.LONGITUDE = Number(line.LONGITUDE);
                line.ALTITUDE = Number(line.ALTITUDE);

                return airportData[line.IATA] = [line.LONGITUDE, line.LATITUDE];
            }

              function lineGraphLegend() {

                var legendData = [
                    { "x": 620, "y": 30},
                    { "x": 620, "y": 60},
                    { "x": 620, "y": 90},
                    { "x": 620, "y": 120},
                    { "x": 620, "y": 150},
                    { "x": 620, "y": 180},
                    { "x": 620, "y": 210},
                    { "x": 620, "y": 240},
                    { "x": 620, "y": 270},
                    { "x": 620, "y": 300},
                    { "x": 620, "y": 330},
                    { "x": 620, "y": 360},
                 ];
              //create rectangles
                var legendRect = svg_lineGraph.selectAll("rect")
                    .data(legendData)
                    .enter()
                    .append("rect")
                    .attr("x", function (d) { return d.x; })
                    .attr("y", function (d) { return d.y; })
                    .attr("width", 10)
                    .style("height", 10)
                    .attr("fill", function(d, i) { return colorScale_lineGraph(i); });

                for (var i = 0; i < legendData.length; i++) {
                  svg_lineGraph.append("text")
                  .attr("x", legendData[i].x+15)
                  .attr("y", legendData[i].y+5)
                  .attr("text-anchor", "start")
                  .attr("alignment-baseline", "central")
                  .text(function (d) {
                    if(airlineDataByDay[i].airline == "EV"){
                      return "ExpressJet Airlines";
                    }
                    else if(airlineDataByDay[i].airline == "HA")
                      return "Hawaiian Airlines";
                    else if(airlineDataByDay[i].airline == "B6")
                      return "JetBlue Airways";
                    else if(airlineDataByDay[i].airline == "F9")
                      return "Frontier Airlines";
                    else if(airlineDataByDay[i].airline == "AA")
                      return "American Airlines";
                    else if(airlineDataByDay[i].airline == "UA")
                      return "United Airlines";
                    else if(airlineDataByDay[i].airline == "VX")
                      return "Virgin America";
                    else if(airlineDataByDay[i].airline == "OO")
                      return "SkyWest Airlines";
                    // else if(airlineDataByDay[i].airline == "UA")
                      // return "United Airlines";
                    else if(airlineDataByDay[i].airline == "AS")
                      return "Alaska Airlines";
                    else if(airlineDataByDay[i].airline == "NK")
                      return "Spirit Airlines";
                    else if(airlineDataByDay[i].airline == "DL")
                      return "Delta Airlines";
                    else if(airlineDataByDay[i].airline == "WN")
                      return "Southwest Airlines";

                    else {
                      return airlineDataByDay[i].airline;
                    }
                  });

                }
              }
            d3.queue()
                .defer(d3.json, "us.json")
                .defer(d3.csv, "data/processed/flights_by_airport_2016.csv")
                .defer(d3.csv, "data/lookups/airport_coordinates_usa.csv", parseAirportsLine)
                .defer(d3.csv, "data/processed/flights_by_airline_2016.csv")
                .await(showMap);

            var width_map = map_svg.attr("width");
            var height_map = map_svg.attr("height");


            function showMap(error, data_map, data_flights_by_airport, data_airport_lkp, data_flights_by_airline) {
                rawDataAirport = data_map;

                states = topojson.feature(rawDataAirport, rawDataAirport.objects.states);

                projection.fitExtent([[0,0], [width_map, height_map]], states);
                pathGenerator = d3.geoPath().projection(projection);

                var paths = map_svg.selectAll("path.state").data(states.features);
                paths.enter().append("path").attr("class", "state")
                .merge(paths)
                .attr("d", function (state) {
                    return pathGenerator(state);
                });

                rawFlightData = data_flights_by_airport;

                flightData = d3.nest()
                    .key(function(d) { return d.AIRPORT; })
                    .rollup(function(v) { return {
                        totalDelays: d3.sum(v, function(d) { return d.TOTAL_DELAYS; }),
                        totalDelayMins: d3.sum(v, function(d) { return d.DELAY_MINS_TOTAL; }),
                        totalCancellations: d3.sum(v, function(d) { return d.CANCELLED_TOTAL; }),
                        totalFlights: d3.sum(v, function(d) { return d.TOTAL_FLIGHTS; }),
                        totalCarrierDelays: d3.sum(v, function(d) { return d.CARRIER_DELAY_TOTAL; }),
                        totalWeatherDelays: d3.sum(v, function(d) { return d.WEATHER_DELAY_TOTAL; }),
                        totalNASDelays: d3.sum(v, function(d) { return d.NAS_DELAY_TOTAL; }),
                        totalSecurity: d3.sum(v, function(d) { return d.SECURITY_DELAY_TOTAL; }),
                        totalLateAircraftDelays: d3.sum(v, function(d) { return d.LATE_AIRCRAFT_DELAY_TOTAL; })
                        };
                    }).entries(rawFlightData);

                flightData = flightData.sort(function (a,b) {return d3.descending(a.value.totalFlights, b.value.totalFlights); });

                busiest20Airports = flightData.slice(0, 20);

                //busiest20Airports.splice(14, 1);

                var NYCTotalDelays = 0,
                    NYCTotalDelayMins = 0,
                    NYCTotalCancellations = 0,
                    NYCTotalFlights = 0,
                    NYCTotalCarrierDelays = 0,
                    NYCTotalWeatherDelays = 0,
                    NYCTotalNASDelays = 0,
                    NYCTotalSecurity = 0,
                    NYCTotalLateAircraftDelays = 0;
                    airportList = ["JFK", "LGA", "EWR"];

                busiest20Airports.forEach(function(d) {
                    if(airportList.indexOf(d.key) < 0) {
                        mergedAirports.push(d);
                    } else {
                        NYCTotalDelays += d.value.totalDelays;
                        NYCTotalDelayMins += d.value.totalDelayMins
                        NYCTotalCancellations += d.value.totalCancellations;
                        NYCTotalFlights += d.value.totalFlights;
                        NYCTotalCarrierDelays += d.value.totalCarrierDelays;
                        NYCTotalWeatherDelays += d.value.totalWeatherDelays;
                        NYCTotalNASDelays += d.value.totalNASDelays;
                        NYCTotalSecurity += d.value.totalSecurity;
                        NYCTotalLateAircraftDelays += d.value.totalLateAircraftDelays;
                    }
                });

                NYCTotalDelays /= airportList.length;
                NYCTotalDelayMins /= airportList.length;
                NYCTotalCancellations /= airportList.length;
                NYCTotalFlights /= airportList.length;
                NYCTotalCarrierDelays /= airportList.length;
                NYCTotalWeatherDelays /= airportList.length;
                NYCTotalNASDelays /= airportList.length;
                NYCTotalSecurity /= airportList.length;
                NYCTotalLateAircraftDelays /= airportList.length;

                mergedAirports.push({"key": "NYC", "value": {"totalDelays": NYCTotalDelays, "totalDelayMins": NYCTotalDelayMins, "totalCancellations": NYCTotalCancellations, "totalFlights": NYCTotalFlights, "totalCarrierDelays": NYCTotalCarrierDelays, "totalWeatherDelays": NYCTotalWeatherDelays, "totalNASDelays": NYCTotalNASDelays, "totalSecurity": NYCTotalSecurity, "totalLateAircraftDelays": NYCTotalLateAircraftDelays}});

                var NYCLatitude = 0;
                var NYCLongitude = 0;

                airportList.forEach(function(d) {
                    NYCLatitude += airportData[d][0];
                    NYCLongitude += airportData[d][1];
                });

                airportData["NYC"] = [NYCLatitude/airportList.length, NYCLongitude/airportList.length];

                var formatPercentage = d3.format('.0%')

                var delayExtent = d3.extent(mergedAirports, function(d) {return d.value.totalFlights});
                
                var delayScale = d3.scalePow().exponent(0.5)
                    .domain(delayExtent)
                    .range([18, 35]);

                var fontScale = d3.scalePow().exponent(0.5)
                    .domain(delayExtent)
                    .range([10, 22]);

                var pie = d3.pie().value(function(d){ return d }).sort(null);

                //var delayReasons = ["totalCarrierDelays", "totalWeatherDelays", "totalNASDelays", "totalLateAircraftDelays"];
                var delayReasons = [{"delayReason": "totalCarrierDelays", "delayDescription": "Carrier Delays"}, {"delayReason": "totalWeatherDelays", "delayDescription": "Weather Delays"}, {"delayReason": "totalNASDelays", "delayDescription": "NAS Delays"}, {"delayReason": "totalLateAircraftDelays", "delayDescription": "Late Aircraft Delays"}];

                var legendX = 50

                map_svg.selectAll("legend_box").data(delayReasons)
                    .enter()
                    .append("rect")
                    .attr("id", "legend_" + function(d) { return d.delayReason; })
                    .attr("class", "legend_box")
                    .attr("x", function(d, i) { legendX += 160; return legendX; })
                    .attr("y", 20)
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("fill", function(d, i) { return colorScale_map(i); });

                d3.selectAll(".legend_box").each( function (d, i) {
                    var legendBox = d3.select(this);
                    map_svg.append("text")
                        .attr("id", "legendText_" + d.delayReason)
                        .attr("class", "legendLabels")
                        .attr("x", Number(legendBox.attr("x")) + Number(legendBox.attr("width")))
                        .attr("y", Number(legendBox.attr("y")) + (Number(legendBox.attr("height")/2)))
                        .attr("dx", 5)
                        .attr("text-anchor", "start")
                        .attr("alignment-baseline", "middle")
                        .attr('font-size', 14)
                        .attr('font-weight',"bold")
                        .text(d.delayDescription);
                });

                var legendPercent = map_svg.append("circle")
                    .attr("id", "percentageLegend")
                    .attr("r", 15)
                    .attr("cx", 30)
                    .attr("cy", 30)
                    .attr("fill", "white")
                    .attr('stroke', '#000')
                    .attr('stroke-width', '1')
                    .style("stroke-opacity", "0.5");

                map_svg.append("text")
                    .attr("id", "percentageTextLegend")
                    .attr("x", legendPercent.attr("cx"))
                    .attr("y", legendPercent.attr("cy"))
                    .attr("text-anchor", "middle")
                    .attr("alignment-baseline", "middle")
                    .attr('font-size', 12)
                    .attr('font-weight',"bold")
                    .text("9%");

                map_svg.append("text")
                    .attr("id", "percentageTextLegend")
                    .attr("x", Number(legendPercent.attr("cx")) + Number(legendPercent.attr("r")))
                    .attr("y", legendPercent.attr("cy"))
                    .attr("dx", 5)
                    .attr("text-anchor", "start")
                    .attr("alignment-baseline", "middle")
                    .attr('font-size', 14)
                    .attr('font-weight',"bold")
                    .text("% Delayed Flights");

                map_svg.selectAll('.airportPie').data(mergedAirports)
                    .enter()
                    .append('g')
                    .attr('class', 'airportPie')
                    .attr("transform", function(d) {
                      return "translate(" + projection(airportData[d.key])[0] + "," + projection(airportData[d.key])[1] + ")";
                    })
                    .each(function(chartData, i) {
                        var pieRadius = delayScale(chartData.value.totalFlights);
                        var mapCoordinates = projection(airportData[chartData.key])
                        var chartContainer = d3.select(this);// Selects the containing 'g'

                        map_svg.append("circle")
                            .attr("id", "circleBG_" + chartData.key)
                            .attr("class", "circleBackgrounds")
                            .attr("r", pieRadius - 8)
                            .attr("cx", mapCoordinates[0])
                            .attr("cy", mapCoordinates[1])
                            .attr("fill", "white");

                        var delayTotalsData = []
                        delayReasons.forEach(function(reason){
                            delayTotalsData = delayTotalsData.concat(chartData.value[reason.delayReason]);
                        });

                        chartContainer.selectAll("path")
                            .data(pie(delayTotalsData))
                            .enter()
                            .append("path")
                            .attr("d", d3.arc().innerRadius(pieRadius - 7).outerRadius(pieRadius))
                            .attr("class", "arc")
                            .style('fill', function(d, i) { return colorScale_map(i); })
                            .attr('stroke', '#fff')
                            .attr('stroke-width', '1')
                            .style("stroke-opacity", "0.75")
                            .attr("class", "arc");

                        map_svg.append("text")
                            .attr("id", "delayPercentage_" + chartData.key)
                            .attr("class", "delayPercentages")
                            .attr("x", mapCoordinates[0])
                            .attr("y", mapCoordinates[1])
                            .attr("text-anchor", "middle")
                            .attr("alignment-baseline", "middle")
                            .attr('font-size', fontScale(chartData.value.totalFlights))
                            .attr('font-weight',"bold")
                            .text(formatPercentage(chartData.value.totalDelays/chartData.value.totalFlights));

                        map_svg.append("text")
                            .attr("id", "label_" + chartData.key)
                            .attr("class", "airportLabels")
                            .attr("x", mapCoordinates[0])
                            .attr("y", mapCoordinates[1])
                            .attr("text-anchor", "middle")
                            .attr("alignment-baseline", "hanging")
                            .attr("dy", pieRadius + 5 )
                            .text(chartData.key);
                    });

                    rawDataAirline = data_flights_by_airline;
                    dailyFlightData = d3.nest()
                    .key(function (d) { return d.AIRLINE; })
                    // .key(function(d) { return d.MONTH; })
                    .rollup(function(v) { return {
                        // month: function(d) { return d.MONTH;},
                        hoursDelayMon: d3.sum(v, function(d) { return d.MON_HOURS_DELAY;}),
                        hoursDelayTue: d3.sum(v, function(d) { return d.TUE_HOURS_DELAY;}),
                        hoursDelayWed: d3.sum(v, function(d) { return d.WED_HOURS_DELAY;}),
                        hoursDelayThu: d3.sum(v, function(d) { return d.THU_HOURS_DELAY;}),
                        hoursDelayFri: d3.sum(v, function(d) { return d.FRI_HOURS_DELAY;}),
                        hoursDelaySat: d3.sum(v, function(d) { return d.SAT_HOURS_DELAY;}),
                        hoursDelaySun: d3.sum(v, function(d) { return d.SUN_HOURS_DELAY;}),

                        totalDelayMon: d3.sum(v, function(d) { return d.MON_TOTAL_DELAYS;}),
                        totalDelayTue: d3.sum(v, function(d) { return d.TUE_TOTAL_DELAYS;}),
                        totalDelayWed: d3.sum(v, function(d) { return d.WED_TOTAL_DELAYS;}),
                        totalDelayThu: d3.sum(v, function(d) { return d.THU_TOTAL_DELAYS;}),
                        totalDelayFri: d3.sum(v, function(d) { return d.FRI_TOTAL_DELAYS;}),
                        totalDelaySat: d3.sum(v, function(d) { return d.SAT_TOTAL_DELAYS;}),
                        totalDelaySun: d3.sum(v, function(d) { return d.SUN_TOTAL_DELAYS;})

                        };

                    })
                    .entries(rawDataAirline);

                    airlineDataByDelays = d3.nest()
                        .key(function(d) { return d.AIRLINE; })
                        .rollup(function(v) {
                            return {
                                totalDelayByline: d3.sum(v, function (d) {return d.TOTAL_DELAYS;}),
                                delayMins: d3.sum(v, function (d) {return d.DELAY_MINS_TOTAL;}),
                                totalCancellByline: d3.sum(v, function (d) {return d.CANCELLED_TOTAL;}),
                                totalFlightsByline: d3.sum(v, function (d) {return d.TOTAL_FLIGHTS;}),
                                carrierDelays: d3.sum(v, function (d) {return d.CARRIER_DELAY_TOTAL;}),
                                weatherDelays: d3.sum(v, function (d) {return d.WEATHER_DELAY_TOTAL;}),
                                nasDelays: d3.sum(v, function (d) {return d.NAS_DELAY_TOTAL;}),
                                securityDelays: d3.sum(v, function (d) {return d.SECURITY_DELAY_TOTAL;}),
                                lateAircraftDelays: d3.sum(v, function (d) {return d.LATE_AIRCRAFT_DELAY_TOTAL})
                            };
                        })
                        .entries(rawDataAirline);

                    dailyFlightData.forEach(function(d) {

                        airlineDataByDay.push({"airline": d.key, "values": [{"Day": "Sunday", "avg": d.value.hoursDelaySun/d.value.totalDelaySun}, {"Day": "Monday", "avg": d.value.hoursDelayMon/d.value.totalDelayMon}, {"Day": "Tuesday", "avg": d.value.hoursDelayTue/d.value.totalDelayTue}, {"Day": "Wednesday", "avg": d.value.hoursDelayWed/d.value.totalDelayWed}, {"Day": "Thursday", "avg": d.value.hoursDelayThu/d.value.totalDelayThu}, {"Day": "Friday", "avg": d.value.hoursDelayFri/d.value.totalDelayFri}, {"Day": "Saturday", "avg": d.value.hoursDelaySat/d.value.totalDelaySat}]});
                    });

                    airlineDataByDay= airlineDataByDay.sort(function (a,b) {return d3.descending(a.values[6].avg, b.values[6].avg); });

                    // Scales and axis
                      var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
                      var weekScale = d3.scalePoint()
                          .domain(days)
                          .range([0,500])
                          .padding(0.3);
                      var weekAxis = d3.axisBottom(weekScale);
                      var delayMinScale = d3.scaleLinear().domain([30,80]).range([300, 0]);
                      var delayMinAxis = d3.axisLeft(delayMinScale).ticks(6);

                      // add gridlines on y
                      var yGridlines = d3.axisLeft(delayMinScale).ticks(6);
                      var gridWidth = weekScale.range()[1];
                      svg_lineGraph.append("g")
                      .attr("class", "grid")
                      .attr("transform", "translate(60,50)")
                      .style("stroke-opacity", 0.5)
                      .style("stroke-dasharray", ("5,5"))
                      .call(yGridlines.tickSize(-gridWidth,0).tickFormat(""));

                      // show axises
                      var plot_lineGraph = svg_lineGraph.append("g").attr("transform", "translate(60,50)");
                      plot_lineGraph.append("g").call(weekAxis).attr("transform", "translate(0,300)");
                      plot_lineGraph.append("g").call(delayMinAxis).attr("transform", "translate(0,0)").attr("stroke-opacity",0);

                     // show the path
                      var pathGenerator = d3.line()
                        .x(function (d) { return weekScale(d.Day); })
                        .y(function (d) { return delayMinScale(d.avg); })
                        .curve(d3.curveMonotoneX);

                function barChartTrends (top10Airline) {
                    var flightsExtent = d3.extent(top10Airline, function (d) {
                        return d.value.totalFlightsByline;
                    });

                    var flightScale = d3.scaleLinear()
                        .domain(flightsExtent)
                        .range([30, 800]);


                    var delaysExtent = d3.extent(top10Airline,
                        function (d) {
                            return d.value.totalDelayByline;
                        });

                    var delaysScale = d3.scaleSqrt()
                        .domain(delaysExtent)
                        .range([60, 360]);


                    var cancellsExtent = d3.extent(top10Airline,
                        function (d) {
                            return d.value.totalCancellByline;
                        });

                    var cancellsScale = d3.scaleSqrt()
                        .domain(cancellsExtent)
                        .range([60, 360]);

                    // add texts of axises:


                    svg_barchart.append("text")
                        .text("Average Length & Number of Delays")
                        .attr("x",  630)
                        .attr("y",  75)
                        .style("font-size","16pt")
                        .style("fill","gray");

                    svg_barchart.append("text")
                        .text("Number of Cancellations")
                        .attr("x",  70)
                        .attr("y", 75)
                        .style("font-size","16pt")
                        .style("fill","gray");



                    // add Legend texts
                    svg_barchart.append("text")
                        .text("Main Cause of Delays")
                        .attr("x",810)
                        .attr("y", 635)
                        .attr("fill", "black")
                        .style("font-size", "8pt");
                    svg_barchart.append("text")
                        .text("Late aircraft")
                        .attr("x",815)
                        .attr("y", 665)
                        .attr("fill", "black")
                        .style("font-size", "8pt");
                    svg_barchart.append("text")
                        .text("Carrier")
                        .attr("x",815)
                        .attr("y", 700)
                        .attr("fill", "black")
                        .style("font-size", "8pt");
                    svg_barchart.append("text")
                        .text("NAS")
                        .attr("x",815)
                        .attr("y", 735)
                        .attr("fill", "black")
                        .style("font-size", "8pt");

                    // add frame of Legends
                    svg_barchart.append("rect")
                        .attr("id","legendframe")
                        .attr("x", 765)
                        .attr("y", 620)
                        .attr("width", 160)
                        .attr("height", 130)
                        .style("fill", "none")
                        .style("stroke","gray")
                        .style("stroke-width","1pt");


                    //Append a defs (for definition) element to  SVG
                    var defs = svg_barchart.append("defs");

                    //Append a linearGradient element to the defs and give it a unique id
                    var linearGradient = defs.append("linearGradient")
                            .attr("id", "linear-gradient");


                    //Vertical gradient
                    linearGradient
                        .attr("x1", "0%")
                        .attr("y1", "0%")
                        .attr("x2", "0%")
                        .attr("y2", "100%");


                    //Set the color for the start (0%)
                    linearGradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", "#636363"); //dark purple

                    //Set the color for the end (100%)
                    linearGradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", "#bdbdbd"); //light
                          
                    var triangle_size = 65;
                    var top_offset = 90;
                    var y_axis_width = 70;
                    var side_offset = 30;
                    
                    var recVerticle = svg_barchart
                        .append("rect")
                        .attr("id","ppp")
                        .attr("x", width_barchart/2 - y_axis_width/2)
                        .attr("y", top_offset)
                        .attr("width", y_axis_width)
                        .attr("height", height_barchart-top_offset)
                        .style("fill", "url(#linear-gradient)");;

                    console.log(width_barchart/2);
                    console.log(cancellsScale(cancellationsAirlineExtent[1]));
                    svg_barchart.append("line")
                        .style("stroke", "black")
                        .attr("x1", width_barchart/2 - cancellsScale(cancellationsAirlineExtent[1]) - y_axis_width/2)
                        .attr("y1", top_offset)
                        .attr("x2", width_barchart/2 + delaysScale(delaysAirlineExtent[1]) + y_axis_width/2)
                        .attr("y2", top_offset);
                    
                    svg_barchart.append("text")
                        .text(delaysAirlineExtent[1])
                        .attr("x",width_barchart/2 + delaysScale(delaysAirlineExtent[1]) + y_axis_width/2)
                        .attr("y", top_offset)
                        .attr("alignment-baseline", "hanging")
                        .attr("text-anchor", "start")
                        .attr("fill", "black")
                        .style("font-size", "8pt");
                        
                    svg_barchart.append("text")
                        .text(cancellationsAirlineExtent[1])
                        .attr("x",width_barchart/2 - cancellsScale(cancellationsAirlineExtent[1]) - y_axis_width/2)
                        .attr("y", top_offset)
                        .attr("alignment-baseline", "hanging")
                        .attr("text-anchor", "end")
                        .attr("fill", "black")
                        .style("font-size", "8pt");
                        
                    // add arrow for flights bar
                    var triangle = d3.symbol().size(triangle_size*triangle_size).type(d3.symbolTriangle);

                    var triangleArrow = svg_barchart
                        .append('path')
                        .attr("transform", "translate(" + width_barchart/2+ "," + triangle_size +")")
                        .attr("d", triangle)
                        .style("fill", "#636363");

                    svg_barchart.append("text")
                        .text("Airline")
                        .attr("x", width_barchart/2)
                        .attr("y", triangle_size)
                        .attr("alignment-baseline", "hanging")
                        .attr("text-anchor", "middle")
                        .style("font-size","16pt")
                        .style("fill","#feb24c");
                    // delay bars

                    var barchart_area = height_barchart/top10Airline.length;

                    var ptns = ['dots', 'vertical', 'horizontal', 'diagonal'];

                    top10Airline.forEach(function (d) {
                        var ptns = ['dots', 'vertical', 'horizontal', 'diagonal'];
                        svg_barchart.selectAll("rect2")
                            .data(top10Airline)
                            .enter()
                            .append("rect")
                            .attr("x", width_barchart/2 + y_axis_width/2)
                            .attr("y", function (d, i) {
                                return top_offset + 10 + i * barchart_area;
                            })
                            .attr("width", function (d) {
                                return delaysScale(d.value.totalDelayByline);
                            })
                            .attr("height", barchart_area/3*2)
                            .attr("fill", function (d, i){
                                return "url(#pattern-" + ptns[reasonsDelayBar.indexOf(tempArray[d.key])] + "-1)";
                            });
                        });



                // cancellation bars
                top10Airline.forEach(function (d) {

                    svg_barchart.selectAll("rect3")
                        .data(top10Airline)
                        .enter()
                        .append("rect")
                        .attr("x", function (d) {
                            return width_barchart/2 - cancellsScale(d.value.totalCancellByline) - y_axis_width/2;
                        })
                        .attr("y", function (d, i) {
                            return top_offset + 10 + i * barchart_area;
                        })
                        .attr("width", function (d) {
                            return cancellsScale(d.value.totalCancellByline);
                        })
                        .attr("height", barchart_area/3*2)
                        .attr("fill", function (d){
                                return "url(#pattern-" + ptns[reasonsCancellationBar.indexOf(cancellationReasons[d.key])] + "-0)";
                            });
                    });
                    // Airline Name Text
                    top10Airline.forEach(function (d) {
                        svg_barchart.selectAll("text5")
                            .data(top10Airline)
                            .enter()
                            .append("text")
                            .text(function (d) {
                                return d.key;
                            })
                            .attr("x", 485)
                            .attr("y", function (d, i) {
                                return top_offset + 10 + i * barchart_area + barchart_area/3*1;
                            })
                            .attr("fill", "white")
                            .style("font-size", "15pt");
                        });

                    // Average delay time Text
                    top10Airline.forEach(function (d) {
                        svg_barchart.selectAll("text2")
                            .data(top10Airline)
                            .enter()
                            .append("text")
                            .text(function (d) {
                                return +Math.round((d.value.delayMins / d.value.totalDelayByline), 0) + " Mins";
                            })
                            .attr("x", function (d) {
                                return width_barchart/2 + y_axis_width/2 + delaysScale(d.value.totalDelayByline)/2;
                            })
                            .attr("y", function (d, i) {
                                return top_offset + 10 + i * barchart_area + barchart_area/3*1;
                            })
                            .attr("alignment-baseline", "middle")
                            .attr("text-anchor", "middle")
                            .attr("fill", "purple")
                            .style("font-size", "10pt");
                        });
               
                    // Average delay time Text
                    top10Airline.forEach(function (d) {
                        svg_barchart.selectAll("text2")
                            .data(top10Airline)
                            .enter()
                            .append("text")
                            .text(function (d) {
                                return d.value.totalFlightsByline + " Flights";
                            })
                            .attr("x", function (d) {
                                return width_barchart/2 + y_axis_width/2 - y_axis_width/2;
                            })
                            .attr("y", function (d, i) {
                                return top_offset + 10 + i * barchart_area + barchart_area/5*3;
                            })
                            .attr("alignment-baseline", "middle")
                            .attr("text-anchor", "middle")
                            .attr("fill", "#000080")
                            .style("font-size", "7pt");
                        });

                var colorScalePattern = d3.scaleOrdinal(['#fde0dd','#fa9fb5','#fff']);
                // texture patterns
                var patternDefinitions = svg_barchart.append('svg:defs');

                var allpatternDots = patternDefinitions.selectAll(".patternDots")
                    .data(colorScalePattern.range())
                    .enter().append('svg:pattern')
                    .attr('id', function(d, i) { return "pattern-dots-" + i; })
                    .attr('class', 'patternDots')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('patternUnits', 'userSpaceOnUse');
                allpatternDots
                    .append('svg:rect')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('fill', function(d, i) { return colorScalePattern(i); });
                allpatternDots
                    .append('svg:rect')
                    .attr('x', 4)
                    .attr('y', 4)
                    .attr('width', 2)
                    .attr('height', 2)
                    .attr('fill',"gray");
                var allpatternDiagonals = patternDefinitions.selectAll(".patternDiagonals")
                    .data(colorScalePattern.range())
                    .enter().append('svg:pattern')
                    .attr('id', function(d, i) { return "pattern-diagonal-" + i; })
                    .attr('class', 'patternDiagonals')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('patternUnits', 'userSpaceOnUse');
                allpatternDiagonals
                    .append('svg:rect')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('fill', function(d, i) { return colorScalePattern(i); });
                allpatternDiagonals
                    .append('svg:path')
                    .attr('d', 'M-1,1 l2,-2 M0,5 l5,-5 M4,6 l2,-2')
                    .attr('stroke', 'gray')
                    .attr('stroke-width', 1);
                var allpatternHorizontal = patternDefinitions.selectAll(".patternHorizontal")
                    .data(colorScalePattern.range())
                    .enter().append('svg:pattern')
                    .attr('id', function(d, i) { return "pattern-horizontal-" + i; })
                    .attr('class', 'patternHorizontal')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('patternUnits', 'userSpaceOnUse');
                allpatternHorizontal
                    .append('svg:rect')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('fill', function(d, i) { return colorScalePattern(i); });
                allpatternHorizontal
                    .append('svg:rect')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', 10)
                    .attr('height', 1)
                    .attr('fill',"gray");
                var allpatternVertical = patternDefinitions.selectAll(".patternVertical")
                    .data(colorScalePattern.range())
                    .enter().append('svg:pattern')
                    .attr('id', function(d, i) { return "pattern-vertical-" + i; })
                    .attr('class', 'patternVertical')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('patternUnits', 'userSpaceOnUse');
                allpatternVertical
                    .append('svg:rect')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('fill', function(d, i) { return colorScalePattern(i); });
                allpatternVertical
                    .append('svg:rect')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', 1)
                    .attr('height', 10)
                    .attr('fill',"gray")
                    .style("opacity", 0.75);

                // add Legends
                var legend = ["Late aircraft","Carrier","NAS"];

                legend.forEach(function (d, i) {
                    var ptns = ['dots', 'vertical', 'horizontal', 'diagonal'];

                    svg_barchart.selectAll("rect5")
                        .data(legend)
                        .enter()
                        .append("rect")
                        .attr("x", 780)
                        .attr("y", function (d, i) {
                            return 650 + i * 34;
                        })
                        .attr("width", 25)
                        .attr("height",25)
                        .attr("fill", function (d,i){
                            return "url(#pattern-" + ptns[i] +"-2)";
                        });
                    });
                }
                
                var rank = [1,14.3,2,1,18.3,3.8,19.8,2.1,0.9,15.1,4.1,1.1];
                var airlineRank = [];
                airlineDataByDelays.forEach(function(d) {
                  airlineRank[d.key] = d.value.totalFlightsByline
                  // airlineRank.push({"airline": d.key,"number": d.value.totalFlightsByline});
                });

                var rankScale = d3.scaleLog().domain([69000, 1300000]).range([1, 12]);;

                function lineGraphTrends(data) {
                    // Create or modify paths for each airline
                    var paths = plot_lineGraph.selectAll("path.lineGraph").data(data);
                    paths.enter().append("path")
                        .merge(paths)
                        .attr("class", "lineGraph")
                        .attr("d", function(sector) {
                            airlineName = sector.airline;
                            return pathGenerator(sector.values);
                        })
                        .style("stroke", function(sector, i) {
                            lineColor = colorScale_lineGraph(i);
                            return colorScale_lineGraph(i);
                        })
                        .style("stroke-width", function(d,i){
                            return rankScale(airlineRank[d.airline]);
                        })
                        .style("stroke-opacity",0.6);
                }

                // Show the line graph legend and trend lines
                lineGraphLegend();
                lineGraphTrends(airlineDataByDay);

                // Show the graph labels
                svg_lineGraph.append("text")
                    .attr("x", 60)
                    .attr("y", 40)
                    .text("Delay time(mins)")
                    .attr("font-size", 12);

                svg_lineGraph.append("text")
                    .attr("x", 295)
                    .attr("y", 400)
                    .text("Days")
                    .attr("font-size", 15);

                airlineDataByDelays = d3.nest()
                    .key(function(d) { return d.AIRLINE; })
                    .rollup(function(v) {
                        return {
                            totalDelayByline: d3.sum(v, function (d) {return d.TOTAL_DELAYS;}),
                            delayMins: d3.sum(v, function (d) {return d.DELAY_MINS_TOTAL;}),
                            totalCancellByline: d3.sum(v, function (d) {return d.CANCELLED_TOTAL;}),
                            totalFlightsByline: d3.sum(v, function (d) {return d.TOTAL_FLIGHTS;}),
                            carrierDelays: d3.sum(v, function (d) {return d.CARRIER_DELAY_TOTAL;}),
                            weatherDelays: d3.sum(v, function (d) {return d.WEATHER_DELAY_TOTAL;}),
                            nasDelays: d3.sum(v, function (d) {return d.NAS_DELAY_TOTAL;}),
                            securityDelays: d3.sum(v, function (d) {return d.SECURITY_DELAY_TOTAL;}),
                            lateAircraftDelays: d3.sum(v, function (d) {return d.LATE_AIRCRAFT_DELAY_TOTAL}),
                            carrierCancellations: d3.sum(v, function (d) {return d.CANCELLATIONS_CARRIER}),
                            weatherCancellations: d3.sum(v, function (d) {return d.CANCELLATIONS_WEATHER}),
                            nasCancellations: d3.sum(v, function (d) {return d.CANCELLATIONS_NAS}),
                            securityCancellations: d3.sum(v, function (d) {return d.CANCELLATIONS_SECURITY})
                        };
                    })
                    .entries(rawDataAirline);

                
                cancellationsAirlineExtent = d3.extent(airlineDataByDelays, function(d) {return d.value.totalCancellByline});
                delaysAirlineExtent = d3.extent(airlineDataByDelays, function(d) {return d.value.totalDelayByline});
                
                 airlineDataByDelays = airlineDataByDelays.sort(function (a,b) {return d3.descending(a.value.totalFlightsByline, b.value.totalFlightsByline); });

                 top10Airline = airlineDataByDelays.slice(0,10);

                 for (var i = 0; i < top10Airline.length; i++) {
                     var max = 0;
                     var tempString = "";
                     if (top10Airline[i].value.carrierDelays > max){
                         max = top10Airline[i].value.carrierDelays;
                         tempString = "carrierDelays";
                     }
                     if (top10Airline[i].value.lateAircraftDelays > max) {
                         max = top10Airline[i].value.lateAircraftDelays;
                         tempString = "lateAircraftDelays";
                     }
                     if (top10Airline[i].value.nasDelays > max) {
                         max = top10Airline[i].value.nasDelays;
                         tempString = "nasDelays";
                     }
                     if (top10Airline[i].value.securityDelays > max) {
                         max = top10Airline[i].value.securityDelays;
                         tempString = "securityDelays";
                     }

                     if(top10Airline[i].value.weatherDelays > max) {
                         max = top10Airline[i].value.weatherDelays;
                         tempString = "weatherDelays";
                     }

                     tempArray[top10Airline[i].key] = tempString;

                }
                
                cancellationReasons = {};
                
                for (var i = 0; i < top10Airline.length; i++) {
                     var max = 0;
                     var tempReason = "";
                     if (top10Airline[i].value.carrierCancellations > max){
                         max = top10Airline[i].value.carrierCancellations;
                         tempReason = "carrierCancellations";
                     }
                     if (top10Airline[i].value.nasCancellations > max) {
                         max = top10Airline[i].value.nasCancellations;
                         tempReason = "nasCancellations";
                     }
                     if (top10Airline[i].value.securityCancellations > max) {
                         max = top10Airline[i].value.securityCancellations;
                         tempReason = "securityCancellations";
                     }

                     if(top10Airline[i].value.weatherCancellations > max) {
                         max = top10Airline[i].value.weatherCancellations;
                         tempReason = "weatherCancellations";
                     }

                     cancellationReasons[top10Airline[i].key] = tempReason;

                }

                var svgDefs = svg_barchart.append('defs');

                var mainGradient = svgDefs.append('linearGradient')
                    .attr('id', 'mainGradient');

                // Create the stops of the main gradient. Each stop will be assigned
                // a class to style the stop using CSS.
                mainGradient.append('stop')
                    .attr('class', 'stop-left')
                    .attr('offset', '0');

                mainGradient.append('stop')
                    .attr('class', 'stop-right')
                    .attr('offset', '1');
                
                barChartTrends(top10Airline);
            }

        </script>

    </body>
</html>
