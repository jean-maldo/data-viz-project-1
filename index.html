<!DOCTYPE html>
<html>

    <head>
        <title>Flight Delays and Cancellations in 2016</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="http://d3js.org/topojson.v2.min.js"></script>
        <style>
            svg {border: 1px solid black}
            .point { fill: black; }
            path.trajectory { fill: none; }
            path.state { fill: #eee; stroke: #aaa;; }
        </style>
    </head>

    <body>
        <h1>INFO 5100 - Project 1</h1>
        <h2>Flight Delays and Cancellations in 2016</h2>
        
        <div id="map">Flight delays by airport (busiest 20)
            <br />
            <svg id="map_delays" height="500" width="800">
            </svg>
        </div>
        
        <script>
            var svg = d3.select("#map_delays");

            var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

            // D3 Projection
            var projection = d3.geoAlbersUsa();
                var pathGenerator = d3.geoPath().projection(projection);

            var rawFlightData;
            var flightData;
            var busiest20Airports;
            var airportData = {};
            
            var rawData;
            var states;
            
            var parseMap = function (error, data) {
                rawData = data;
                
                console.log("Code in the call-back function is only executed when the data file loads.");
                
                states = topojson.feature(rawData, rawData.objects.states);
                showMap();
            }
            
            function parseFlightsLine (line) {
                line.DELAY_MINS_TOTAL = Number(line.DELAY_MINS_TOTAL);
                line.TOTAL_DELAYS = Number(line.TOTAL_DELAYS);
                line.CANCELLED_TOTAL = Number(line.CANCELLED_TOTAL);
                line.TOTAL_FLIGHTS = Number(line.TOTAL_FLIGHTS);
                return line;
            }
            
            function parseAirportsLine (line) {
                line.LATITUDE = Number(line.LATITUDE);
                line.LONGITUDE = Number(line.LONGITUDE);
                line.ALTITUDE = Number(line.ALTITUDE);
                
                return airportData[line.IATA] = {"LATITUDE": line.LATITUDE, "LONGITUDE": line.LONGITUDE};
            }

            var parseFlights = function(error, data) {
                rawFlightData = data;
                
                flightData = d3.nest()
                    .key(function(d) { return d.AIRPORT; })
                    .rollup(function(v) { return {
                        totalDelays: d3.sum(v, function(d) { return d.TOTAL_DELAYS; }),
                        totalDelayMins: d3.sum(v, function(d) { return d.DELAY_MINS_TOTAL; }),
                        totalCancellations: d3.sum(v, function(d) { return d.CANCELLED_TOTAL; }),
                        totalFlights: d3.sum(v, function(d) { return d.TOTAL_FLIGHTS; })
                        };
                    })
                    .entries(rawFlightData);
                    flightData = flightData.sort(function (a,b) {return d3.descending(a.value.totalFlights, b.value.totalFlights); });
                    
                    busiest20Airports = flightData.slice(0, 20);
            }
            
            d3.queue()
                .defer(d3.json, "us.json", parseMap)
                .defer(d3.csv, "../data/processed/flights_by_airport_2016.csv", parseFlightsLine, parseFlights)
                .defer(d3.csv, "../data/lookups/airport_coordinates_usa.csv", parseAirportsLine)
                .await(showMap);

            var width_map = svg.attr("width");
            var height_map = svg.attr("height");
            
            function showMap() {
                // Create or modify paths for each state
                
                projection.fitExtent([[0,0], [width_map, height_map]], states);
                pathGenerator = d3.geoPath().projection(projection);
                
                var paths = svg.selectAll("path.state").data(states.features);
                paths.enter().append("path").attr("class", "state")
                .merge(paths)
                .attr("d", function (state) {
                    return pathGenerator(state);
                });
                
                
            }
        </script>
    </body>
</html>